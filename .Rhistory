posterior2 <- m_2 %>%
posterior::as_draws() %>%
posterior::subset_draws(
variable = c(
"b_substrate_depth30",
"b_seed_density8",
"b_target_typedry_grassland",
"b_sand_ratio25",
"b_sand_ratio50",
"b_expositionnorth",
"sd_site__Intercept",
"sd_site:plot__Intercept",
"sd_botanist_year__Intercept",
"sigma"
)
)
hmc_diagnostics1 <- nuts_params(m_1)
hmc_diagnostics2 <- nuts_params(m_2)
y <- sites$n
yrep1 <- posterior_predict(m_1, draws = 500)
yrep2 <- posterior_predict(m_2, draws = 500)
loo1 <- loo(m_1, save_psis = TRUE, moment_match = FALSE)
loo2 <- loo(m_2, save_psis = TRUE, moment_match = FALSE)
### Samling efficency/effectiveness (Rhat and EFF) ###
draws1 <- m_1 %>%
posterior::as_draws() %>%
posterior::summarize_draws() %>%
filter(str_starts(variable, "b_"))
draws2 <- m_2 %>%
posterior::as_draws() %>%
posterior::summarize_draws() %>%
filter(str_starts(variable, "b_"))
range(draws1$rhat)
range(draws2$rhat)
range(draws1$ess_bulk)
range(draws2$ess_bulk)
range(draws1$ess_tail)
range(draws2$ess_tail)
### MCMC diagnostics ###
mcmc_trace(posterior1, np = hmc_diagnostics1)
mcmc_trace(posterior2, np = hmc_diagnostics2)
mcmc_pairs(posterior1, off_diag_args = list(size = 1.2))
mcmc_scatter(m_1,
pars = c("b_survey_year_fct2020", "b_survey_year_fct2019"),
np = hmc_diagnostics1,
size = 1)
mcmc_scatter(m_2,
pars = c("b_survey_year_fct2020", "b_survey_year_fct2019"),
np = hmc_diagnostics2,
size = 1)
mcmc_parcoord(posterior1, np = hmc_diagnostics1)
mcmc_parcoord(posterior2, np = hmc_diagnostics2)
### Posterior predictive check ###
#### Kernel density
ppc_dens_overlay(y, yrep1[1:50, ])
ppc_dens_overlay(y, yrep2[1:50, ])
ppc_dens_overlay_grouped(y, yrep1[1:50, ], group = sites$site)
ppc_dens_overlay_grouped(y, yrep2[1:50, ], group = sites$site)
m3_iter <- brm(n ~ (target_type + exposition + sand_ratio + survey_year_fct)^2 +
substrate_depth + seed_density +
substrate_depth:sand_ratio +
seed_density:exposition +
target_type:exposition:survey_year_fct +
sand_ratio:exposition:survey_year_fct +
seed_density:exposition:survey_year_fct +
(1 | site/plot) + (1 | botanist_year),
data = sites,
family = gaussian("identity"),
prior = priors,
chains = chains,
iter = 10000,
thin = thin,
warmup = floor(iter / 2),
save_pars = save_pars(all = TRUE),
cores = parallel::detectCores(),
seed = 123)
#m_1 <- m3_flat
m_1 <- m3_iter
m_2 <- m3
createDHARMa(
simulatedResponse = t(posterior_predict(m_1)),
observedResponse = sites$n,
fittedPredictedResponse = apply(t(posterior_epred(m_1)), 1, mean),
integerResponse = TRUE
) %>%
plot()
createDHARMa(
simulatedResponse = t(posterior_predict(m_2)),
observedResponse = sites$n,
fittedPredictedResponse = apply(t(posterior_epred(m_2)), 1, mean),
integerResponse = TRUE
) %>%
plot()
posterior1 <- m_1 %>%
posterior::as_draws() %>%
posterior::subset_draws(
variable = c(
"b_substrate_depth30",
"b_seed_density8",
"b_target_typedry_grassland",
"b_sand_ratio25",
"b_sand_ratio50",
"b_expositionnorth",
"sd_site__Intercept",
"sd_site:plot__Intercept",
"sd_botanist_year__Intercept",
"sigma"
)
)
posterior2 <- m_2 %>%
posterior::as_draws() %>%
posterior::subset_draws(
variable = c(
"b_substrate_depth30",
"b_seed_density8",
"b_target_typedry_grassland",
"b_sand_ratio25",
"b_sand_ratio50",
"b_expositionnorth",
"sd_site__Intercept",
"sd_site:plot__Intercept",
"sd_botanist_year__Intercept",
"sigma"
)
)
hmc_diagnostics1 <- nuts_params(m_1)
hmc_diagnostics2 <- nuts_params(m_2)
(emm <- emmeans(m_1, revpairwise ~ target_type + sand_ratio |
exposition | survey_year_fct, type = "response"))
### Packages ###
library(here)
library(tidyverse)
library(ggbeeswarm)
### Start ###
#rm(list = setdiff(ls(), c("graph_a", "graph_b", "graph_c", "graph_d")))
setwd(here("data", "processed"))
### Load data ###
sites <- read_csv("data_processed_sites.csv",
col_names = TRUE,
na = c("na", "NA", ""), col_types =
cols(
.default = "?",
id = "f",
plot = "f",
sites = "f",
exposition = col_factor(levels = c("north", "south")),
sand_ratio = "f",
substrate_depth = col_factor(levels = c("30", "15")),
target_type = "f",
seed_density = "f"
)) %>%
filter(survey_year != "seeded") %>%
mutate(
n = fcs_target,
survey_year_fct = factor(survey_year)
) %>%
select(
id, plot, site, exposition, sand_ratio, substrate_depth, target_type,
seed_density, survey_year_fct, n
)
### Load data ###
sites <- read_csv("data_processed_sites.csv",
col_names = TRUE,
na = c("na", "NA", ""), col_types =
cols(
.default = "?",
id = "f",
plot = "f",
site = "f",
exposition = col_factor(levels = c("north", "south")),
sand_ratio = "f",
substrate_depth = col_factor(levels = c("30", "15")),
target_type = "f",
seed_density = "f"
)) %>%
filter(survey_year != "seeded") %>%
mutate(
n = fcs_target,
survey_year_fct = factor(survey_year)
) %>%
select(
id, plot, site, exposition, sand_ratio, substrate_depth, target_type,
seed_density, survey_year_fct, n
)
### * Model ####
m <- m3
### * Functions ####
theme_mb <- function() {
theme(
panel.background = element_rect(fill = "white"),
text = element_text(size = 9, color = "black"),
strip.text = element_text(size = 10),
axis.text = element_text(angle = 0, hjust = 0.5, size = 9,
color = "black"),
axis.title = element_text(angle = 0, hjust = 0.5, size = 9,
color = "black"),
axis.line = element_line(),
legend.key = element_rect(fill = "white"),
legend.position = "right",
legend.margin = margin(0, 0, 0, 0, "cm"),
plot.margin = margin(0, 0, 0, 0, "cm")
)
}
(graph_a <- ggplot() +
geom_quasirandom(
aes(y = n, x = sandRatio, color = targetType),
data = sites,
alpha = 0.5,
dodge.width = 0.8,
cex = .5
) +
geom_hline(
yintercept = 0,
linetype = "dashed",
size = .3,
color = "grey70"
) +
geom_boxplot(
aes(y = n, x = sandRatio, fill = targetType),
data = sites,
alpha = 0.5
) +
facet_grid(
exposition ~ surveyYear_fac,
labeller = as_labeller(
c(south = "South", north = "North",
"2018" = "2018", "2019" = "2019", "2020" = "2020", "2021" = "2021")
)
) +
scale_y_continuous(limits = c(-2.8, 1.9), breaks = seq(-100, 400, 1)) +
scale_color_manual(labels = c("Hay meadow", "Dry grassland"),
values = c("#00BFC4", "#F8766D")) +
scale_fill_manual(labels = c("Hay meadow", "Dry grassland"),
values = c("#00BFC4", "#F8766D")) +
labs(
x = "Sand ratio [%]", fill = "", color = "",
y = expression(
Favourable ~ Conservation ~ Status ~ "(FCS)"
)
) +
theme_mb())
(graph_a <- ggplot() +
geom_quasirandom(
aes(y = n, x = sand_ratio, color = target_type),
data = sites,
alpha = 0.5,
dodge.width = 0.8,
cex = .5
) +
geom_hline(
yintercept = 0,
linetype = "dashed",
size = .3,
color = "grey70"
) +
geom_boxplot(
aes(y = n, x = sand_ratio, fill = target_type),
data = sites,
alpha = 0.5
) +
facet_grid(
exposition ~ survey_year_fct,
labeller = as_labeller(
c(south = "South", north = "North",
"2018" = "2018", "2019" = "2019", "2020" = "2020", "2021" = "2021")
)
) +
scale_y_continuous(limits = c(-2.8, 1.9), breaks = seq(-100, 400, 1)) +
scale_color_manual(labels = c("Hay meadow", "Dry grassland"),
values = c("#00BFC4", "#F8766D")) +
scale_fill_manual(labels = c("Hay meadow", "Dry grassland"),
values = c("#00BFC4", "#F8766D")) +
labs(
x = "Sand ratio [%]", fill = "", color = "",
y = expression(
Favourable ~ Conservation ~ Status ~ "(FCS)"
)
) +
theme_mb())
(graph_a <- ggplot() +
geom_quasirandom(
aes(y = n, x = sand_ratio, color = target_type),
data = sites,
alpha = 0.5,
dodge.width = 0.8,
cex = .5
) +
geom_hline(
yintercept = 0,
linetype = "dashed",
size = .3,
color = "grey70"
) +
#geom_boxplot(
#  aes(y = n, x = sand_ratio, fill = target_type),
#  data = sites,
#  alpha = 0.5
#) +
facet_grid(
exposition ~ survey_year_fct,
labeller = as_labeller(
c(south = "South", north = "North",
"2018" = "2018", "2019" = "2019", "2020" = "2020", "2021" = "2021")
)
) +
scale_y_continuous(limits = c(-2.8, 1.9), breaks = seq(-100, 400, 1)) +
scale_color_manual(labels = c("Hay meadow", "Dry grassland"),
values = c("#00BFC4", "#F8766D")) +
scale_fill_manual(labels = c("Hay meadow", "Dry grassland"),
values = c("#00BFC4", "#F8766D")) +
labs(
x = "Sand ratio [%]", fill = "", color = "",
y = expression(
Favourable ~ Conservation ~ Status ~ "(FCS)"
)
) +
theme_mb())
### a sandRatio x target Type -------------------------------------------------
m %>%
tidy_draws(m) %>%
summarise_draws() %>%
ggplot()
### a sandRatio x target Type -------------------------------------------------
m %>%
tidy_draws(m) %>%
summarise_draws() #%>%
### a sandRatio x target Type -------------------------------------------------
m %>%
tidy_draws() %>%
summarise_draws() #%>%
### a sandRatio x target Type -------------------------------------------------
m %>%
posterior::as_draws() %>%
posterior::summarise_draws() #%>%
### a sandRatio x target Type -------------------------------------------------
get_variables(m)
### a sandRatio x target Type -------------------------------------------------
get_variables(m) %>% slice(20)
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[1:20]
m %>%
posterior::as_draws() %>%
posterior::summarise_draws() #%>%
m %>%
posterior::as_draws() %>%
posterior::summarise_draws() %>%
spread_draws
m %>%
spread_draws()
m %>%
spread_draws(b_taret_typedry_grassland)
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[1:20]
m %>%
spread_draws("b_taret_typedry_grassland")
m %>%
spread_draws(b_target_typedry_grassland)
m %>%
spread_draws(b_target_typedry_grassland[c,t])
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[1:30]
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[1:50]
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[1:55]
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[40:60]
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[40:80]
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[40:100]
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[40:150]
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[90:200]
### a sandRatio x target Type -------------------------------------------------
get_variables(m)[1:20]
m %>%
spread_draws(b_target_typedry_grassland)
m %>%
spread_draws(b_target_typedry_grassland, b_exposition)
m %>%
spread_draws(b_target_typedry_grassland, b_expositionnorth)
m %>%
spread_draws(b_target_typedry_grassland, b_expositionnorth, b_sand_ratio25,
b_sand_ratio50, b_survey_year_fct2019, b_survey_year_fct2020,
b_survey_year_fct2021)
m %>%
spread_draws(b_target_typedry_grassland, b_expositionnorth, b_sand_ratio25,
b_sand_ratio50, b_survey_year_fct2019, b_survey_year_fct2020,
b_survey_year_fct2021) %>%
mean_qi(b_target_typedry_grassland, b_expositionnorth, b_sand_ratio25,
b_sand_ratio50, b_survey_year_fct2019, b_survey_year_fct2020,
b_survey_year_fct2021)
m %>%
spread_draws(b_target_typedry_grassland, b_expositionnorth, b_sand_ratio25,
b_sand_ratio50, b_survey_year_fct2019, b_survey_year_fct2020,
b_survey_year_fct2021) %>%
mean_qi()
m %>%
spread_draws(b_target_typedry_grassland, b_expositionnorth, b_sand_ratio25,
b_sand_ratio50, b_survey_year_fct2019, b_survey_year_fct2020,
b_survey_year_fct2021) %>%
summarise_draws()
m %>%
spread_draws(b_target_typedry_grassland, b_expositionnorth, b_sand_ratio25,
b_sand_ratio50, b_survey_year_fct2019, b_survey_year_fct2020,
b_survey_year_fct2021) %>%
summarise_draws() %>%
ggplot(aes(y = mean, ymin = q5, ymax = q95, x = variable))
m %>%
spread_draws(b_target_typedry_grassland, b_expositionnorth, b_sand_ratio25,
b_sand_ratio50, b_survey_year_fct2019, b_survey_year_fct2020,
b_survey_year_fct2021) %>%
summarise_draws() %>%
ggplot(aes(x = mean, xmin = q5, xmax = q95, y = variable)) %>%
geom_pointinterval()
m %>%
spread_draws(b_target_typedry_grassland, b_expositionnorth, b_sand_ratio25,
b_sand_ratio50, b_survey_year_fct2019, b_survey_year_fct2020,
b_survey_year_fct2021) %>%
summarise_draws() %>%
ggplot(aes(x = mean, xmin = q5, xmax = q95, y = variable)) +
geom_pointinterval()
m %>%
spread_draws(b_target_typedry_grassland, b_expositionnorth, b_sand_ratio25,
b_sand_ratio50, b_survey_year_fct2019, b_survey_year_fct2020,
b_survey_year_fct2021) %>%
summarise_draws() %>%
ggplot(aes(x = mean, xmin = q5, xmax = q95, y = variable)) +
stat_halfeye()
m %>%
spread_draws(b_target_typedry_grassland, b_expositionnorth, b_sand_ratio25,
b_sand_ratio50, b_survey_year_fct2019, b_survey_year_fct2020,
b_survey_year_fct2021) %>%
mutate(mean = b_Intercept + variable) %>%
ggplot(aes(x = mean, y = variable)) +
stat_halfeye()
m %>%
spread_draws(b_Intercept, b_target_typedry_grassland, b_expositionnorth,
b_sand_ratio25, b_sand_ratio50, b_survey_year_fct2019,
b_survey_year_fct2020, b_survey_year_fct2021) %>%
mutate(mean = b_Intercept + variable) %>%
ggplot(aes(x = mean, y = variable)) +
stat_halfeye()
m %>%
spread_draws(b_Intercept, b_target_typedry_grassland, b_expositionnorth,
b_sand_ratio25, b_sand_ratio50, b_survey_year_fct2019,
b_survey_year_fct2020, b_survey_year_fct2021) #%>%
m %>%
gather_draws(b_Intercept, b_target_typedry_grassland, b_expositionnorth,
b_sand_ratio25, b_sand_ratio50, b_survey_year_fct2019,
b_survey_year_fct2020, b_survey_year_fct2021) #%>%
m %>%
gather_draws(b_Intercept, b_target_typedry_grassland, b_expositionnorth,
b_sand_ratio25, b_sand_ratio50, b_survey_year_fct2019,
b_survey_year_fct2020, b_survey_year_fct2021) %>%
filter(.variable = "b_Intercept")
m %>%
gather_draws(b_Intercept, b_target_typedry_grassland, b_expositionnorth,
b_sand_ratio25, b_sand_ratio50, b_survey_year_fct2019,
b_survey_year_fct2020, b_survey_year_fct2021) %>%
filter(.variable == "b_Intercept" | .variable == "b_target_typedry_grassland") %>%
ggplot(aes(x = .value, y = .variable)) +
stat_halfeye()
m %>%
gather_draws(b_Intercept, b_target_typedry_grassland, b_expositionnorth,
b_sand_ratio25, b_sand_ratio50, b_survey_year_fct2019,
b_survey_year_fct2020, b_survey_year_fct2021) %>%
filter(.variable == "b_Intercept" | .variable == "b_target_typedry_grassland") %>%
ggplot(aes(x = .value, y = .variable)) +
stat_halfeye() +
geom_vline(0)
m %>%
gather_draws(b_Intercept, b_target_typedry_grassland, b_expositionnorth,
b_sand_ratio25, b_sand_ratio50, b_survey_year_fct2019,
b_survey_year_fct2020, b_survey_year_fct2021) %>%
filter(.variable == "b_Intercept" | .variable == "b_target_typedry_grassland") %>%
ggplot(aes(x = .value, y = .variable)) +
stat_halfeye() +
geom_vline(xintercept = 0, linetype = "dashed")
m %>%
gather_draws(b_Intercept, b_target_typedry_grassland, b_expositionnorth,
b_sand_ratio25, b_sand_ratio50, b_survey_year_fct2019,
b_survey_year_fct2020, b_survey_year_fct2021) %>%
filter(.variable == "b_Intercept" | .variable == "b_target_typedry_grassland") %>%
ggplot(aes(x = .value, y = .variable)) +
stat_halfeye() +
geom_vline(xintercept = 0, linetype = "dashed") +
theme_bw
m %>%
gather_draws(b_Intercept, b_target_typedry_grassland, b_expositionnorth,
b_sand_ratio25, b_sand_ratio50, b_survey_year_fct2019,
b_survey_year_fct2020, b_survey_year_fct2021) %>%
filter(.variable == "b_Intercept" | .variable == "b_target_typedry_grassland") %>%
ggplot(aes(x = .value, y = .variable)) +
stat_halfeye() +
geom_vline(xintercept = 0, linetype = "dashed") +
theme_bw()
m %>%
gather_draws(b_Intercept, b_target_typedry_grassland, b_expositionnorth,
b_sand_ratio25, b_sand_ratio50, b_survey_year_fct2019,
b_survey_year_fct2020, b_survey_year_fct2021) %>%
filter(.variable == "b_Intercept" | .variable == "b_target_typedry_grassland") %>%
ggplot(aes(x = .value, y = .variable)) +
stat_halfeye() +
geom_vline(xintercept = 0, linetype = "dashed") +
theme_mb()
m %>%
data_grid(target_type)
m %>%
modelr::data_grid(target_type)
