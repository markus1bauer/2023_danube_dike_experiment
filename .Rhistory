Tspecies <- Tspecies %>%
pivot_longer(-name, "site", "value") %>%
pivot_wider(site, name) %>%
column_to_rownames("site")
Ttraits <- column_to_rownames(Ttraits, "name")
log_Ttraits <- log(Ttraits)
TdiversityAbu <- dbFD(log_Ttraits, Tspecies, w.abun = T,
calc.FRic = F, calc.FDiv = F, corr = "cailliez")
sites$fdisAbuLHS <- TdiversityAbu$FDis
traits %>%
filter(group != "tree" & group != "shrub") %>%
left_join(species, by = "name") %>%
count() #241 species remain
length(traitsLHS$name) / (247 - 12) #97.8%, (247 - 12) = species without shrubs and trees - species XXX_spec.
Tspecies <- semi_join(species, traitsSLA, by = "name")
Ttraits <- semi_join(traitsSLA, Tspecies, by = "name")
Tspecies <- Tspecies %>%
pivot_longer(-name, "site", "value") %>%
pivot_wider(site, name) %>%
column_to_rownames("site")
Ttraits <- column_to_rownames(Ttraits, "name")
log_Ttraits <- log(Ttraits)
TdiversityAbu <- dbFD(log_Ttraits, Tspecies, w.abun = T,
calc.FRic = F, calc.FDiv = F, corr = "sqrt");
sites$fdisAbuSla <- TdiversityAbu$FDis
sites$cwmAbuSla <- TdiversityAbu$CWM$sla %>%
as.character() %>% as.numeric() %>% exp()
undefinedSpeciesCount <- traits %>%
filter(group != "tree" & group != "shrub") %>%
filter(name == str_detect(name, "_spec"))
View(undefinedSpeciesCount)
undefinedSpeciesCount <- traits %>%
filter(group != "tree" & group != "shrub") #%>%
View(undefinedSpeciesCount)
undefinedSpeciesCount <- traits %>%
filter(group != "tree" & group != "shrub") %>%
filter(name = str_detect(name, "_spec"))
undefinedSpeciesCount <- traits %>%
filter(group != "tree" & group != "shrub") %>%
filter(str_detect(name, "_spec"))
View(Ttraits)
View(undefinedSpeciesCount)
undefinedSpeciesCount <- traits %>%
filter(group != "tree" & group != "shrub") %>%
filter(str_detect(name, "_spec" | "Öhrchen"))
undefinedSpeciesCount <- traits %>%
filter(group != "tree" & group != "shrub") %>%
filter(str_detect(name, "_spec|Öhrchen"))
View(undefinedSpeciesCount)
undefinedSpeciesCount <- traits %>%
filter(group != "tree" & group != "shrub") %>%
filter(str_detect(name, "_spec|Öhrchen")) %>%
left_join(species, by = "name") %>%
count()
View(undefinedSpeciesCount)
undefinedSpeciesCount <- traits %>%
filter(group != "tree" & group != "shrub") %>%
filter(str_detect(name, "_spec|Öhrchen")) %>%
left_join(species, by = "name") %>%
count() %>%
as.vector()
View(undefinedSpeciesCount)
undefinedSpeciesCount <- traits %>%
filter(group != "tree" & group != "shrub") %>%
filter(str_detect(name, "_spec|Öhrchen")) %>%
left_join(species, by = "name") %>%
count() %>%
pull()
herbCount <- traits %>%
filter(group != "tree" & group != "shrub") %>%
left_join(species, by = "name") %>%
count() %>%
pull()
length(traitsLHS$name) / (herbCount - undefinedundefinedSpeciesCount)
length(traitsLHS$name) / (herbCount)# - undefinedundefinedSpeciesCount)
length(traitsLHS$name) / (herbCount) - undefinedSpeciesCount)
length(traitsLHS$name) / (herbCount) - undefinedSpeciesCount)
length(traitsLHS$name) / (herbCount - undefinedSpeciesCount)
### a LHS -------------------------------------------------------------------------------------------
Tspecies <- semi_join(species, traitsLHS, by = "name")
Ttraits <- semi_join(traitsLHS, Tspecies, by = "name")
Tspecies <- Tspecies %>%
pivot_longer(-name, "site", "value") %>%
pivot_wider(site, name) %>%
column_to_rownames("site")
Ttraits <- column_to_rownames(Ttraits, "name")
log_Ttraits <- log(Ttraits)
TdiversityAbu <- dbFD(log_Ttraits, Tspecies, w.abun = T,
calc.FRic = F, calc.FDiv = F, corr = "cailliez")
sites$fdisAbuLHS <- TdiversityAbu$FDis
length(traitsLHS$name) / (herbCount - undefinedSpeciesCount)
### b SLA -------------------------------------------------------------------------------------------
Tspecies <- semi_join(species, traitsSLA, by = "name")
Ttraits <- semi_join(traitsSLA, Tspecies, by = "name")
Tspecies <- Tspecies %>%
pivot_longer(-name, "site", "value") %>%
pivot_wider(site, name) %>%
column_to_rownames("site")
Ttraits <- column_to_rownames(Ttraits, "name")
log_Ttraits <- log(Ttraits)
TdiversityAbu <- dbFD(log_Ttraits, Tspecies, w.abun = T,
calc.FRic = F, calc.FDiv = F, corr = "sqrt");
sites$fdisAbuSla <- TdiversityAbu$FDis
sites$cwmAbuSla <- TdiversityAbu$CWM$sla %>%
as.character() %>% as.numeric() %>% exp()
length(traitsSLA$name) / (herbCount - undefinedSpeciesCount)
### c Seed mass -------------------------------------------------------------------------------------------
Tspecies <- semi_join(species, traitsSM, by = "name")
Ttraits <- semi_join(traitsSM, Tspecies, by = "name")
Tspecies <- Tspecies %>%
pivot_longer(-name, "site", "value") %>%
pivot_wider(site, name) %>%
column_to_rownames("site")
Ttraits <- column_to_rownames(Ttraits, "name")
log_Ttraits <- log(Ttraits)
TdiversityAbu <- dbFD(log_Ttraits, Tspecies, w.abun = T,
calc.FRic = F, calc.FDiv = F, corr = "sqrt");
sites$fdisAbuSeedmass <- TdiversityAbu$FDis
sites$cwmAbuSeedmass <- TdiversityAbu$CWM$seedmass %>%
as.character() %>% as.numeric() %>% exp()
length(traitsSM$name) / (herbCount - undefinedSpeciesCount)
### d Canopy height -------------------------------------------------------------------------------------------
Tspecies <- semi_join(species, traitsH, by = "name")
Ttraits <- semi_join(traitsH, Tspecies, by = "name")
Tspecies <- Tspecies %>%
pivot_longer(-name, "site", "value") %>%
pivot_wider(site, name) %>%
column_to_rownames("site")
Ttraits <- column_to_rownames(Ttraits, "name")
log_Ttraits <- log(Ttraits)
TdiversityAbu <- dbFD(log_Ttraits, Tspecies, w.abun = T,
calc.FRic = F, calc.FDiv = F, corr = "sqrt");
sites$fdisAbuHeight <- TdiversityAbu$FDis
sites$cwmAbuHeight <- TdiversityAbu$CWM$height %>%
as.character() %>% as.numeric() %>% exp()
length(traitsH$name) / (herbCount - undefinedSpeciesCount)
### e Specific root length -------------------------------------------------------------------------------------------
Tspecies <- semi_join(species, traitsSRL, by = "name")
Ttraits <- semi_join(traitsSRL, Tspecies, by = "name")
Tspecies <- Tspecies %>%
pivot_longer(-name, "site", "value") %>%
pivot_wider(site, name) %>%
column_to_rownames("site")
Ttraits <- column_to_rownames(Ttraits, "name")
log_Ttraits <- log(Ttraits)
TdiversityAbu <- dbFD(log_Ttraits, Tspecies, w.abun = T,
calc.FRic = F, calc.FDiv = F, corr = "sqrt");
sites$fdisAbuSrl <- TdiversityAbu$FDis
sites$cwmAbuSrl <- TdiversityAbu$CWM$srl %>%
as.character() %>% as.numeric() %>% exp()
length(traitsSRL$name) / (herbCount - undefinedSpeciesCount)
### f Root mass fraction -------------------------------------------------------------------------------------------
Tspecies <- semi_join(species, traitsRMF, by = "name")
Ttraits <- semi_join(traitsRMF, Tspecies, by = "name")
Tspecies <- Tspecies %>%
pivot_longer(-name, "site", "value") %>%
pivot_wider(site, name) %>%
column_to_rownames("site")
Ttraits <- column_to_rownames(Ttraits, "name")
log_Ttraits <- log(Ttraits)
TdiversityAbu <- dbFD(log_Ttraits, Tspecies, w.abun = T,
calc.FRic = F, calc.FDiv = F, corr = "sqrt");
sites$fdisAbuRmf <- TdiversityAbu$FDis
sites$cwmAbuRmf <- TdiversityAbu$CWM$rmf %>%
as.character() %>% as.numeric() %>% exp()
length(traitsRMF$name) / (herbCount - undefinedSpeciesCount)
### g All -------------------------------------------------------------------------------------------
Tspecies <- semi_join(species, traitsAll, by = "name")
Ttraits <- semi_join(traitsAll, Tspecies, by = "name")
Tspecies <- Tspecies %>%
pivot_longer(-name, "site", "value") %>%
pivot_wider(site, name) %>%
column_to_rownames("site")
Ttraits <- column_to_rownames(Ttraits, "name")
log_Ttraits <- log(Ttraits)
TdiversityAbu <- dbFD(log_Ttraits, Tspecies, w.abun = T,
calc.FRic = F, calc.FDiv = F, corr = "cailliez")
sites$fdisAbuAll <- TdiversityAbu$FDis
length(traitsAll$name) / (herbCount - undefinedSpeciesCount)
setwd(here("data/processed"))
write_csv2(sites, "data_processed_sites.csv")
write_csv2(species, "data_processed_species.csv")
write_csv2(traits, "data_processed_traits.csv")
write_csv2(tbiAbu, "data_processed_tbiAbu.csv")
write_csv2(tbiPa, "data_processed_tbiPa.csv")
### Packages ###
library(here)
library(tidyverse)
library(raster)
library(ggmap)
library(sf)
library(mapview)
library(mapedit)
### Start ###
rm(list = ls())
setwd(here("data/raw/spatial"))
register_google(key = "AIzaSyB5nQU_dgB_kPsQkk-_cq7pA0g1-2qka4E")
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# B Load shp files ##########################################################################################################
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
## 1 Base maps #################################################################################################
germany <- raster::getData('GADM', country = 'DEU', level = 0, download =  T) %>%
st_as_sf() %>%
st_set_crs(4326)
bg_google_satellite <- get_map(
location = c(lon = 12.886, lat = 48.839),
zoom = 15,
scale = 1,
maptype = "satellite",
color = "color",
source = "google"
)
ggmap(bg_google_satellite)
bg_stamen_terrain <- get_map(
location= c(left = 12.87, bottom = 48.835, right = 12.895, top = 48.845),
zoom = 14,
scale = 1,
maptype = "terrain-background",
source = "stamen"
)
ggmap(bg_stamen_terrain)
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
### Packages ###
library(tidyverse)
library(sf)
library(raster)
library(ggmap)
library(tmap)
library(RColorBrewer)
library(ggrepel)
library(patchwork)
library(grid)
### Start ###
rm(list = ls())
setwd(here("data/processed/spatial"))
### Load data ###
germany <- st_read("germany.shp")
danube <- st_read("danube.shp")
dikes <- st_read("dikes.shp")
blocks <- st_read("blocks.shp")
blocks2 <- read_csv2("blocks2.csv", col_names = T, col_types =
cols(block = col_factor())
)
bg_google_satellite2 <- raster("bg_google_satellite2.tif")
load("bg_google_satellite.rda")
load("bg_stamen_terrain.rda")
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# B Plot ##############################################################################
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
themeMB <- function(){
theme(
panel.background = element_rect(fill = NA),
panel.grid = element_line(colour = NA),
text  = element_text(size = 10, color = "black"),
axis.title = element_blank(),
axis.text = element_blank(),
axis.ticks = element_blank(),
axis.line.x = element_blank(),
axis.line.y = element_blank(),
legend.position = "none",
plot.margin = margin(.5, 0, 0, 0, "cm")
)
}
## 1 Map with ggmap ##############################################################################
### a Map of project site -----------------------------------------------------------------------
(sitesGraph <- ggmap(bg_google_satellite) +
geom_point(data = blocks2, aes(x = x, y = y), size = 2, color = "white") +
geom_text_repel(data = blocks2, aes(label = block, x = x, y = y),
min.segment.length = 1,
color = "white",
direction = "y",
nudge_y = .001) +
coord_sf(crs = st_crs(4326)) +
ggspatial::annotation_scale(location = "br",
pad_y = unit(0.6, "cm"),
pad_x = unit(0.7, "cm"),
width_hint = 0.4,
height = unit(0.15, "cm"),
text_col = "white") +
ggspatial::annotation_north_arrow(location = "br",
pad_y = unit(1.1, "cm"),
pad_x = unit(0.6, "cm"),
which_north = "true",
style = ggspatial::north_arrow_fancy_orienteering(
text_col = "white"
),
height = unit(.8, "cm"),
width = unit(.8, "cm")) +
themeMB())
### b Germany -----------------------------------------------------------------------
gerGraph <- ggplot() +
geom_sf(data = germany, fill = "transparent", colour = "white") +
geom_point(aes(x = 12.886, y = 48.839), size = 1, colour = "white") +
themeMB() +
theme(
plot.background = element_blank()
)
### c Inset -----------------------------------------------------------------------
sitesGraph + inset_element(gerGraph,
left = .01,
bottom = .1,
right = .3,
top = .4,
on_top = T)
blocks <- st_read("blocks.kml") %>%
group_by(Name) %>%
summarise(geometry = st_combine(geometry)) %>%
st_convex_hull %>%
rename(block = Name) %>%
mutate(block = as_factor(block)) %>%
mutate(block = fct_recode(1 == 13))
### Packages ###
library(here)
library(tidyverse)
library(raster)
library(ggmap)
library(sf)
library(mapview)
library(mapedit)
### Start ###
rm(list = ls())
setwd(here("data/raw/spatial"))
register_google(key = "AIzaSyB5nQU_dgB_kPsQkk-_cq7pA0g1-2qka4E")
dikes <- st_read("Deich.shp") %>%
st_transform(crs = 4326) %>%
st_crop(ymin = 48.835, ymax = 48.845, xmin = 12.87, xmax = 12.895)
blocks <- st_read("blocks.kml") %>%
group_by(Name) %>%
summarise(geometry = st_combine(geometry)) %>%
st_convex_hull %>%
rename(block = Name) %>%
mutate(block = as_factor(block)) %>%
mutate(block = fct_recode(1 == 13))
blocks <- st_read("blocks.kml") %>%
group_by(Name) %>%
summarise(geometry = st_combine(geometry)) %>%
st_convex_hull %>%
rename(block = Name) %>%
mutate(block = as_factor(block)) %>%
mutate(block = fct_recode(13 == 1))
blocks <- st_read("blocks.kml") %>%
group_by(Name) %>%
summarise(geometry = st_combine(geometry)) %>%
st_convex_hull %>%
rename(block = Name) %>%
mutate(block = as_factor(block)) %>%
mutate(block = fct_recode(block, 13 == 1))
blocks <- st_read("blocks.kml") %>%
group_by(Name) %>%
summarise(geometry = st_combine(geometry)) %>%
st_convex_hull %>%
rename(block = Name) %>%
mutate(block = as_factor(block)) %>%
mutate(block = fct_recode(block, 13 == "1"))
blocks <- st_read("blocks.kml") %>%
group_by(Name) %>%
summarise(geometry = st_combine(geometry)) %>%
st_convex_hull %>%
rename(block = Name) %>%
mutate(block = as_factor(block)) %>%
mutate(block = fct_recode(block, "13" == "1"))
blocks <- st_read("blocks.kml") %>%
group_by(Name) %>%
summarise(geometry = st_combine(geometry)) %>%
st_convex_hull %>%
rename(block = Name) %>%
mutate(block = as_factor(block)) %>%
mutate(block = fct_recode(block, "13" = "1"))
blocks <- st_read("blocks.kml") %>%
group_by(Name) %>%
summarise(geometry = st_combine(geometry)) %>%
st_convex_hull %>%
rename(block = Name) %>%
mutate(block = as_factor(block)) %>%
mutate(block = fct_recode(block, "13" = "1", "12" = "2"))
blocks <- st_read("blocks.kml") %>%
group_by(Name) %>%
summarise(geometry = st_combine(geometry)) %>%
st_convex_hull %>%
rename(block = Name) %>%
mutate(block = as_factor(block)) %>%
mutate(block = fct_recode(block, "6" = "1", "5" = "2", "4" = "3", "3" = "4", "2" = "5", "1" = "6"))
View(blocks)
blocks2 <- blocks %>%
st_centroid()
blocks2 <- bind_cols(as_tibble(as_factor(st_drop_geometry(blocks2))), as_tibble(st_coordinates(blocks2))) %>%
rename(x = X, y = Y)
setwd(here("data/processed/spatial"))
write_csv2(blocks2, file = "blocks2.csv")
st_write(blocks, layer = "blocks.shp", driver = "ESRI Shapefile", delete_layer = T,
dsn = here("data/processed/spatial"))
# Show map of the Danube dike experiment ####
# Markus Bauer
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# A Preparation ################################################################################################################
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
### Packages ###
library(tidyverse)
library(sf)
library(raster)
library(ggmap)
library(tmap)
library(RColorBrewer)
library(ggrepel)
library(patchwork)
library(grid)
### Start ###
rm(list = ls())
setwd(here("data/processed/spatial"))
### Load data ###
germany <- st_read("germany.shp")
danube <- st_read("danube.shp")
dikes <- st_read("dikes.shp")
blocks <- st_read("blocks.shp")
blocks2 <- read_csv2("blocks2.csv", col_names = T, col_types =
cols(block = col_factor())
)
bg_google_satellite2 <- raster("bg_google_satellite2.tif")
load("bg_google_satellite.rda")
load("bg_stamen_terrain.rda")
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# B Plot ##############################################################################
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
themeMB <- function(){
theme(
panel.background = element_rect(fill = NA),
panel.grid = element_line(colour = NA),
text  = element_text(size = 10, color = "black"),
axis.title = element_blank(),
axis.text = element_blank(),
axis.ticks = element_blank(),
axis.line.x = element_blank(),
axis.line.y = element_blank(),
legend.position = "none",
plot.margin = margin(.5, 0, 0, 0, "cm")
)
}
## 1 Map with ggmap ##############################################################################
### a Map of project site -----------------------------------------------------------------------
(sitesGraph <- ggmap(bg_google_satellite) +
geom_point(data = blocks2, aes(x = x, y = y), size = 2, color = "white") +
geom_text_repel(data = blocks2, aes(label = block, x = x, y = y),
min.segment.length = 1,
color = "white",
direction = "y",
nudge_y = .001) +
coord_sf(crs = st_crs(4326)) +
ggspatial::annotation_scale(location = "br",
pad_y = unit(0.6, "cm"),
pad_x = unit(0.7, "cm"),
width_hint = 0.4,
height = unit(0.15, "cm"),
text_col = "white") +
ggspatial::annotation_north_arrow(location = "br",
pad_y = unit(1.1, "cm"),
pad_x = unit(0.6, "cm"),
which_north = "true",
style = ggspatial::north_arrow_fancy_orienteering(
text_col = "white"
),
height = unit(.8, "cm"),
width = unit(.8, "cm")) +
themeMB())
### b Germany -----------------------------------------------------------------------
gerGraph <- ggplot() +
geom_sf(data = germany, fill = "transparent", colour = "white") +
geom_point(aes(x = 12.886, y = 48.839), size = 1, colour = "white") +
themeMB() +
theme(
plot.background = element_blank()
)
### c Inset -----------------------------------------------------------------------
sitesGraph + inset_element(gerGraph,
left = .01,
bottom = .1,
right = .3,
top = .4,
on_top = T)
### d Save -----------------------------------------------------------------------
ggsave("figure_1_map_(300dpi_8x11cm).tiff",
dpi = 300, width = 8, height = 11, units = "cm",
path = here("outputs/figures")
)
# 2 Map with tmap ##############################################################################
### a Map of project site -----------------------------------------------------------------------
tmap_mode("plot")
bbox <- st_bbox(c(ymin = 48.835, ymax = 48.845, xmin = 12.87, xmax = 12.895))
#tm_shape(bg_google_satellite2, bbox = bbox) +
#tm_raster()
(tmap <- tm_shape(dikes, bbox = bbox) +
tm_lines() +
tm_shape(danube) +
tm_fill(col = "grey") +
tm_text("river") +
tm_shape(blocks) +
tm_fill("red") +
tm_text("block", size = 1, col = "black", ymod = 0.7) +
tm_compass(position = c("right", "bottom"), size = 2) +
tm_scale_bar(position = c("right", "bottom", with = 0.4)) +
tm_layout(frame = F))
tmap_ger <- tm_shape(germany) +
tm_borders(col = "black") +
tm_layout(frame = F)
### b Save -----------------------------------------------------------------------
tmap_save(tmap,
insets_tm = tmap_ger,
insets_vp = viewport(x = unit(3.1, "cm"),
y = unit(3.3, "cm"),
width = unit(3, "cm"),
height = unit(4, "cm")),
filename = paste0(here("outputs/figures"), "/", "figure_1_map_tmap_(300dpi_8x11cm).tiff"),
dpi = 300)
