#anti_join(tbiStart, tbiEnd, by = "plot")
#anti_join(tbiEnd, tbiStart, by = "plot")
rm(tbiStart, tbiEnd)
tbi <- species %>%
pivot_longer(-name, "id", "n") %>%
pivot_wider(id, name) %>%
left_join(sites, by = "id") %>%
select(id, exposition, surveyYear, Acer_campestre:Vulpia_myuros) %>%
filter(surveyYear == 2018 | surveyYear == 2020) %>%
#tbiStart <- sites %>% select(id, plot, surveyYear) %>% filter(surveyYear == 2018)
#tbiEnd <- sites %>% select(id, plot, surveyYear) %>% filter(surveyYear == 2020)
#anti_join(tbiStart, tbiEnd, by = "plot")
#anti_join(tbiEnd, tbiStart, by = "plot")
#rm(tbiStart, tbiEnd)
column_to_rownames(var = "id") %>%
select(-surveyYear)
View(tbi)
### a Abundance data --------------------------------------------------------------------------------------------
tbi2 <- select(tbi, -exposition)
tbiAbu <- tbi2[,colSums(tbi2) > 0]
### b Presence-absence data--------------------------------------------------------------------------------------------
tbiPa <- tbiAbu
tbiPa[tbiPa > 0] = 1
tbiAbu <- rownames_to_column(tbiAbu, var = "id")
tbiAbu <- rownames_to_column(tbiAbu, var = "id")
tbiPa <- rownames_to_column(tbiPa, var = "id")
tbi <- species %>%
pivot_longer(-name, "id", "n") %>%
pivot_wider(id, name) %>%
left_join(sites, by = "id") %>%
select(id, exposition, surveyYear, Acer_campestre:Vulpia_myuros) %>%
filter(surveyYear == 2018 | surveyYear == 2020) %>%
#tbiStart <- sites %>% select(id, plot, surveyYear) %>% filter(surveyYear == 2018)
#tbiEnd <- sites %>% select(id, plot, surveyYear) %>% filter(surveyYear == 2020)
#anti_join(tbiStart, tbiEnd, by = "plot")
#anti_join(tbiEnd, tbiStart, by = "plot")
#rm(tbiStart, tbiEnd)
column_to_rownames(var = "id") %>%
select(-surveyYear)
### a Abundance data --------------------------------------------------------------------------------------------
tbi2 <- select(tbi, -exposition)
tbiAbu <- tbi2[,colSums(tbi2) > 0]
### b Presence-absence data--------------------------------------------------------------------------------------------
tbiPa <- tbiAbu
tbiPa[tbiPa > 0] = 1
### c Abundance Exposition--------------------------------------------------------------------------------------------
#tbi2 <- tbi %>%
#filter(exposition == "north") %>%
# select(-exposition)
#tbiAbuN <- tbi2[,colSums(tbi2) > 0]
tbiAbu <- rownames_to_column(tbiAbu, var = "id")
tbiPa <- rownames_to_column(tbiPa, var = "id")
#tbiAbuN <- rownames_to_column(tbiAbuN, var = "id")
rm(tbi, tbi2)
### Packages ###
library(tidyverse)
library(vegan)
library(FD) #dbFD()
library(naniar) #are_na()
### Start ###
#installr::updateR(browse_news = F, install_R = T, copy_packages = T, copy_Rprofile.site = T, keep_old_packages = T, update_packages = T, start_new_R = F, quit_R = T, print_R_versions = T, GUI = F)
rm(list = ls())
setwd("Z:/Documents/0_Uni/2022_Donaudeiche/3_Aufnahmen_und_Ergebnisse/2022_Danube_dike_experiment/data/raw")
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# A Load data ##############################################################################
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
### 1 Species #####################################################################################
### a Load species tables of all years -------------------------------------------------------------------------------------------
speciesL18 <- read_csv2("data_raw_species_2018_land.csv", col_names = T, na = c("", "NA", "na"), col_types =
cols(
.default = col_double(),
name = col_factor()
)) %>%
mutate(name = str_replace(name, " ", "_")) %>%
rename_with( ~ paste0("L_", .x), -name) %>%
rename_with(~ paste0(.x, "_2018"), -name) %>%
separate(name, c("name", "descriptor"), " ", extra = "drop", fill = "warn") %>%
mutate(name = as_factor(str_replace(name, "\\.", ""))) %>%
select(-descriptor)
speciesW18 <- read_csv2("data_raw_species_2018_water.csv", col_names = T, na = c("", "NA", "na"), col_types =
cols(
.default = col_double(),
name = col_factor()
)) %>%
mutate(name = str_replace(name, " ", "_")) %>%
rename_with( ~ paste0("W_", .x), -name) %>%
rename_with(~ paste0(.x, "_2018"), -name) %>%
separate(name, c("name", "descriptor"), " ", extra = "drop", fill = "warn") %>%
mutate(name = as_factor(str_replace(name, "\\.", ""))) %>%
select(-descriptor) %>%
mutate(name = fct_recode(name, Plantago_major_ssp_intermedia = "Plantago_major"))
speciesL19 <- read_csv2("data_raw_species_2019_land.csv", col_names = T, na = c("", "NA", "na"), col_types =
cols(
.default = col_double(),
name = col_factor()
)) %>%
mutate(name = str_replace(name, " ", "_")) %>%
rename_with( ~ paste0("L_", .x), -name) %>%
rename_with(~ paste0(.x, "_2019"), -name) %>%
separate(name, c("name", "descriptor"), " ", extra = "drop", fill = "warn") %>%
mutate(name = as_factor(str_replace(name, "\\.", ""))) %>%
select(-descriptor) %>%
mutate(name = fct_recode(name, Plantago_major_ssp_major = "Plantago_major"))
speciesW19 <- read_csv2("data_raw_species_2019_water.csv", col_names = T, na = c("", "NA", "na"), col_types =
cols(
.default = col_double(),
name = col_factor()
)) %>%
mutate(name = str_replace(name, " ", "_")) %>%
rename_with( ~ paste0("W_", .x), -name) %>%
rename_with(~ paste0(.x, "_2019"), -name) %>%
separate(name, c("name", "descriptor"), " ", extra = "drop", fill = "warn") %>%
mutate(name = as_factor(str_replace(name, "\\.", ""))) %>%
select(-descriptor) %>%
mutate(name = fct_recode(name, Plantago_major_ssp_major = "Plantago_major"))
speciesL20 <- read_csv2("data_raw_species_2020_land.csv", col_names = T, na = c("", "NA", "na"), col_types =
cols(
.default = col_double(),
name = col_factor()
)) %>%
mutate(name = str_replace(name, " ", "_")) %>%
rename_with( ~ paste0("L_", .x), -name) %>%
rename_with(~ paste0(.x, "_2020"), -name) %>%
separate(name, c("name", "descriptor"), " ", extra = "drop", fill = "warn") %>%
mutate(name = as_factor(str_replace(name, "\\.", ""))) %>%
select(-descriptor)
speciesW20 <- read_csv2("data_raw_species_2020_water.csv", col_names = T, na = c("", "NA", "na"), col_types =
cols(
.default = col_double(),
name = col_factor()
)) %>%
mutate(name = str_replace(name, " ", "_")) %>%
rename_with( ~ paste0("W_", .x), -name) %>%
rename_with(~ paste0(.x, "_2020"), -name) %>%
mutate(name = str_replace(name, "Plantago_major ssp. major", "Plantago_major_ssp_major")) %>%
mutate(name = str_replace(name, "Plantago_major ssp. intermedia", "Plantago_major_ssp_intermedia")) %>%
separate(name, c("name", "descriptor"), " ", extra = "drop", fill = "warn") %>%
mutate(name = as_factor(str_replace(name, "\\.", ""))) %>%
select(-descriptor)
### b Join species tables -------------------------------------------------------------------------------------------
speciesL <- speciesL18 %>%
full_join(speciesL19, by = "name") %>%
full_join(speciesL20, by = "name")
speciesW <- speciesW18 %>%
full_join(speciesW19, by = "name") %>%
full_join(speciesW20, by = "name")
species <- full_join(speciesL, speciesW) %>%
drop_na(name) %>%
### Rename species ###
mutate(name = fct_recode(name, Carex_praecox_ssp_praecox = "Carex_praecox")) %>%
mutate(name = fct_recode(name, Cerastium_fontanum_ssp_vulgare = "Cerastium_fontanum")) %>%
mutate(name = fct_recode(name, Cerastium_fontanum_ssp_vulgare = "Cerastium_holosteoides")) %>%
mutate(name = fct_recode(name, Cornus_controversa = "Cornus_sanguinea")) %>%
mutate(name = fct_recode(name, Cota_tinctoria = "Anthemis_tinctoris")) %>%
mutate(name = fct_recode(name, Erigeron_canadensis = "Conyza_canadensis")) %>%
mutate(name = fct_recode(name, Fallopia_convolvulus = "Polygonum_convolvulus")) %>%
mutate(name = fct_recode(name, Galium_mollugo = "Galium_album")) %>%
mutate(name = fct_recode(name, Jacobaea_vulgaris = "Senecio_jacobaea")) %>%
mutate(name = fct_recode(name, Persicaria_amphibia = "Polygonum_amphibium")) %>%
mutate(name = fct_recode(name, Persicaria_bistorta = "Bistorta_officinalis")) %>%
mutate(name = fct_recode(name, Persicaria_minor = "Polygonum_minus")) %>%
mutate(name = fct_recode(name, Silene_latifolia_ssp_alba = "Silene_latifolia")) %>%
mutate(name = fct_recode(name, Silene_latifolia_ssp_alba = "Silene_alba")) %>%
mutate(name = fct_recode(name, "Silene_flos-cuculi" = "Lychnis_flos-cuculi")) %>%
mutate(name = fct_recode(name, Taraxacum_campylodes = "Taraxacum_officinale")) %>%
mutate(name = fct_recode(name, Vicia_sativa_ssp_nigra = "Vicia_angustifolia")) %>%
### combine created duplicates ###
group_by(name) %>%
summarise(across(where(is.double), ~sum(.x, na.rm = T))) %>%
### Implement counted inidviduals as 0.5 % in normal columns ###
mutate(across(where(is.numeric) & contains("i"), ~ 0.5 * (. > 0))) %>%
pivot_longer(cols = -name, names_to = "id", values_to = "n") %>%
mutate(id  =  str_replace(id, "i", "")) %>%
group_by(name, id) %>%
summarise(max = max(n, na.rm = T)) %>%
mutate(max = ifelse(is.infinite(max), NA, max)) %>%
pivot_wider(names_from = "id", values_from = "max") %>%
mutate(name = as_factor(name)) %>%
### Check that each species occurs at least one time ###
group_by(name) %>%
mutate(total = sum(c_across(starts_with("L") | starts_with("W")), na.rm = T)) %>%
mutate(presence = if_else(total > 0, 1, 0)) %>%
filter(presence == 1) %>%
ungroup() %>%
select(-total, -presence) %>%
rename_with(~ str_replace(.x, "_1_201", "_01_201")) %>%
rename_with(~ str_replace(.x, "_1_2020", "_01_2020")) %>%
rename_with(~ str_replace(.x, "_2_201", "_02_201")) %>%
rename_with(~ str_replace(.x, "_2_2020", "_02_2020")) %>%
rename_with(~ str_replace(.x, "_3_201", "_03_201")) %>%
rename_with(~ str_replace(.x, "_3_2020", "_03_2020")) %>%
rename_with(~ str_replace(.x, "_4_201", "_04_201")) %>%
rename_with(~ str_replace(.x, "_4_2020", "_04_2020")) %>%
rename_with(~ str_replace(.x, "_5_201", "_05_201")) %>%
rename_with(~ str_replace(.x, "_5_2020", "_05_2020")) %>%
rename_with(~ str_replace(.x, "_6_201", "_06_201")) %>%
rename_with(~ str_replace(.x, "_6_2020", "_06_2020")) %>%
rename_with(~ str_replace(.x, "_7_201", "_07_201")) %>%
rename_with(~ str_replace(.x, "_7_2020", "_07_2020")) %>%
rename_with(~ str_replace(.x, "_8_201", "_08_201")) %>%
rename_with(~ str_replace(.x, "_8_2020", "_08_2020")) %>%
rename_with(~ str_replace(.x, "_9_201", "_09_201")) %>%
rename_with(~ str_replace(.x, "_9_2020", "_09_2020")) %>%
mutate(name = as.character(name)) %>%
arrange(name) %>%
mutate(name = as_factor(name))
rm(list = setdiff(ls(), c("species")))
### 2 Traits #####################################################################################
traits <- read_csv2("data_raw_traits.csv", col_names = T, na = c("", "NA", "na"), col_types =
cols(
.default = col_factor(),
name = col_factor(),
l = col_double(),
t = col_double(),
k = col_double(),
f = col_double(),
r = col_double(),
n = col_double()
)) %>%
separate(name, c("genus", "species", "ssp", "subspecies"), "_", remove = F, extra = "drop", fill = "warn") %>%
mutate(genus = str_sub(genus, 1, 4)) %>%
mutate(species = str_sub(species, 1, 4)) %>%
mutate(subspecies = str_sub(subspecies, 1, 4)) %>%
unite(abb, genus, species, subspecies, sep = "") %>%
mutate(abb = str_replace(abb, "NA", "")) %>%
mutate(abb = as_factor(abb)) %>%
select(-ssp, - descriptor, -synonym, -nomenclature, -legal, -l, -k, -fchange) %>%
#traits[duplicated(traits$abb),]
#Check congruency of traits and species table
#traits$name[which(!(traits$name %in% species$name))]
#species$name[which(!(species$name %in% traits$name))]
semi_join(species, by = "name")
### 3 Sites #####################################################################################
sites <- read_csv2("data_raw_sites.csv", col_names = T, na = c("", "NA", "na"), col_types =
cols(
.default = col_factor(),
vegetationCov_2018 = col_double(),
vegetationCov_2019 = col_double(),
vegetationCov_2020 = col_double(),
surveyDate_2018 = col_date(),
surveyDate_2019 = col_date(),
surveyDate_2020 = col_date()
)) %>%
select(-starts_with("surveyDate"), -starts_with("botanist")) %>%
pivot_longer(starts_with("vegetationCov"), names_to = "surveyYear", values_to ="vegetationCov") %>%
mutate(plot = str_replace(plot, "-", "_")) %>%
mutate(surveyYear = str_replace(surveyYear, "vegetationCov_", "")) %>%
mutate(id = as_factor(str_c(plot, surveyYear, sep = "_")), .keep = "all") %>%
mutate(plot = as_factor(plot))
### Remove plots with no species ###
ids <- as_factor(colnames(species[-1]))
#sites$id[which(!(sites$id %in% ids))]
#ids[which(!(ids %in% sites$id))]
sites <- sites %>%
filter(id %in% ids)
### Remove plots which are not part of the sites tibble ##
species <- species %>%
select(name, all_of(sites$id))
rm(ids)
### Check missing values ###
#miss_var_summary(species, order = T)
#miss_var_summary(sites, order = T)
#vis_miss(species, cluster = F)
#vis_miss(sites, cluster = F)
#sites[is.na(sites$vegetationCov_2018),]
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# B Create variables ##############################################################################
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
### 1 Create simple variables #####################################################################################
sites <- sites %>%
mutate(conf.low = c(1:length(id))) %>%
mutate(conf.high = c(1:length(id)))
traits <- traits %>%
mutate(target = if_else(
targetHerb == "yes" | targetGrass == "yes", "yes", "no"
))
### 2 Coverages #####################################################################################
### a Graminoid covratio; graminoid, herb, and total coverage)-------------------------------------------------------------------------------------------
sites <- species %>%
mutate(type = traits$family) %>%
pivot_longer(names_to = "id", values_to = "n", cols = starts_with("L") | starts_with("W")) %>%
group_by(id, type) %>%
summarise(total = sum(n, na.rm = T)) %>%
mutate(type = if_else(type == "Poaceae" | type == "Cyperaceae" | type == "Juncaceae", "graminoidCov", "herbCov")) %>%
group_by(id, type) %>%
summarise(total = sum(total, na.rm = T)) %>%
spread(type, total) %>%
mutate(graminoidCovratio = graminoidCov / (graminoidCov + herbCov)) %>%
mutate(accumulatedCov = graminoidCov + herbCov) %>%
ungroup() %>%
mutate(graminoidCovratio = round(graminoidCovratio, 3), .keep = "unused") %>%
mutate(accumulatedCov = round(accumulatedCov, 3), .keep = "unused") %>%
right_join(sites, by = "id")
### b Target species' coverage -------------------------------------------------------------------------------------------
sites <- species %>%
mutate(type = traits$target) %>%
pivot_longer(names_to = "id", values_to = "n", cols = starts_with("L") | starts_with("W")) %>%
group_by(id, type) %>%
summarise(total = sum(n, na.rm = T)) %>%
filter(type == "yes") %>%
select(-type) %>%
ungroup() %>%
mutate(targetCov = round(total, 3), .keep = "unused") %>%
right_join(sites, by = "id")
### c Ruderal species' coverage -------------------------------------------------------------------------------------------
sites <- species %>%
mutate(type = traits$ruderalExperiment) %>%
pivot_longer(names_to = "id", values_to = "n", cols = starts_with("L") | starts_with("W")) %>%
group_by(id, type) %>%
