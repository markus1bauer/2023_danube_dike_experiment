seedmixes <- data.table::fread("data_raw_species_20211112.csv",
sep = ",",
dec = ".",
skip = 0,
header = TRUE,
na.strings = c("", "NA", "na"),
colClasses = list(
character = "name"
)) %>%
arrange(name) %>%
select(name, ends_with("seeded")) %>%
filter(name %in% species$name) %>%
select(name, sort(tidyselect::peek_vars())) %>%
mutate(across(where(is.numeric), ~replace(., is.na(.), 0))) %>%
pivot_longer(-name, names_to = "id", values_to = "seeded") %>%
separate(id, c("plot"), sep = "_(?!.*_)",
remove = TRUE, extra = "drop", fill = "warn", convert = FALSE)
traits <- read_csv("data_raw_traits.csv", col_names = TRUE,
na = c("", "NA", "na"),
col_types =
cols(
.default = "f",
name = "c",
l = "d",
t = "d",
k = "d",
f = "d",
r = "d",
n = "d",
)) %>%
separate(name, c("genus", "species", "ssp", "subspecies"), "_",
remove = FALSE, extra = "drop", fill = "right") %>%
mutate(genus = str_sub(genus, 1, 4),
species = str_sub(species, 1, 4),
subspecies = str_sub(subspecies, 1, 4),
name = as.character(name)) %>%
unite(abb, genus, species, subspecies, sep = "", na.rm = TRUE) %>%
mutate(abb = str_replace(abb, "NA", ""),
abb = as_factor(abb)) %>%
select(-ssp, -synonym, -nomenclature, -legal, -l, -k, -fchange) %>%
arrange(name)
### Check congruency of traits and species table ###
traits[duplicated(traits$abb), ]
#traits$name[which(!(traits$name %in% species$name))]
species$name[which(!(species$name %in% traits$name))]
traits <- traits %>%
semi_join(species, by = "name")
traits <- traits %>%
mutate(target = if_else(
targetHerb == "yes" | targetGrass == "yes", "yes", "no"
))
cover <- left_join(species, traits, by = "name") %>%
select(name, family, target, ruderalIndicator, seeded,
starts_with("L"), starts_with("W")) %>%
pivot_longer(names_to = "id", values_to = "n",
cols = starts_with("L") | starts_with("W")) %>%
group_by(id)
### * graminoid, herb, and total coverage) ####
cover_total_and_graminoid <- cover %>%
group_by(id, family) %>%
summarise(total = sum(n, na.rm = TRUE), .groups = "keep") %>%
mutate(type = if_else(
family == "Poaceae" |
family == "Cyperaceae" |
family == "Juncaceae",
"graminoidCov", "herbCov")) %>%
group_by(id, type) %>%
summarise(total = sum(total, na.rm = TRUE), .groups = "keep") %>%
spread(type, total) %>%
mutate(accumulatedCov = graminoidCov + herbCov,
accumulatedCov = round(accumulatedCov, 1)) %>%
ungroup()
### * Target species' coverage ####
cover_target <- cover %>%
filter(target == "yes") %>%
summarise(targetCov = sum(n, na.rm = TRUE)) %>%
mutate(targetCov = round(targetCov, 1)) %>%
ungroup()
### * Ruderal species' coverage ####
cover_ruderalIndicator <- cover %>%
filter(ruderalIndicator == "yes") %>%
summarise(ruderalCov = sum(n, na.rm = TRUE)) %>%
mutate(ruderalCov = round(ruderalCov, 1)) %>%
ungroup()
### * Seeded species' coverage ####
cover_seeded <- species %>%
select(-starts_with("C"), -contains("x0809")) %>%
# Make two columns out of column id:
pivot_longer(-name, names_to = "id", values_to = "value",
values_drop_na = TRUE) %>%
separate(id, c("plot", "surveyYear"), sep = "_(?!.*_)",
remove = FALSE, extra = "merge", fill = "warn", convert = FALSE) %>%
# Summarise for plot:
pivot_wider(names_from = "surveyYear", values_from = "value") %>%
group_by(plot, name) %>%
summarise(across(where(is.double), ~sum(.x, na.rm = TRUE)),
.groups = "keep") %>%
ungroup() %>%
# Combine with seedmixes:
pivot_longer(starts_with("20"), names_to = "surveyYear", values_to = "value",
names_transform = list(surveyYear = as.factor)) %>%
unite(id_seeded, name, plot, sep = "", remove = FALSE) %>%
left_join(seedmixes %>%
unite(id_seeded, name, plot, sep = "", remove = TRUE),
by = "id_seeded") %>%
select(-id_seeded) %>%
mutate(success = if_else(seeded > 0 & value > 0, value, 0)) %>%
group_by(plot, surveyYear) %>%
summarise(seededCov = sum(success, na.rm = TRUE), .groups = "keep") %>%
ungroup() %>%
unite(id, plot, surveyYear, sep = "_")
View(cover_seeded)
### * implement in sites data set ####
sites <- sites %>%
left_join(cover_total_and_graminoid, by = "id") %>%
left_join(cover_target, by = "id") %>%
#right_join(cover_ruderalIndicator, by = "id") %>%
left_join(cover_seeded, by = "id") %>%
### Calcute the ratio of target species richness of total species richness
mutate(targetCovratio = targetCov / accumulatedCov,
graminoidCovratio = graminoidCov / accumulatedCov,
seededCovratio = seededCov / accumulatedCov,
targetCovratio = round(targetCovratio, 3),
graminoidCovratio = round(graminoidCovratio, 3),
seededCovratio = round(seededCovratio, 3))
rm(list = setdiff(ls(), c("sites", "species", "traits", "seedmixes")))
## 3 Alpha diversity ###########################################################
### a Species richness ---------------------------------------------------------
speciesRichness <- species %>%
left_join(traits, by = "name") %>%
select(name, rlg, rlb, target, targetHerb, ffh6510, ffh6210,
starts_with("L"), starts_with("W")) %>%
pivot_longer(names_to = "id", values_to = "n",
cols = starts_with("L") | starts_with("W")) %>%
mutate(n = if_else(n > 0, 1, 0)) %>%
group_by(id)
### * total species richness ####
speciesRichness_all <- speciesRichness %>%
summarise(speciesRichness = sum(n, na.rm = TRUE)) %>%
ungroup()
### * red list Germany (species richness) ####
speciesRichness_rlg <- speciesRichness %>%
filter(rlg == "1" | rlg == "2" | rlg == "3" | rlg == "V") %>%
summarise(rlgRichness = sum(n, na.rm = TRUE)) %>%
ungroup()
### * red list Bavaria (species richness) ####
speciesRichness_rlb <- speciesRichness %>%
filter(rlb == "1" | rlb == "2" | rlb == "3" | rlb == "V") %>%
summarise(rlbRichness = sum(n, na.rm = TRUE)) %>%
ungroup()
### * target species (species richness) ####
speciesRichness_target <- speciesRichness %>%
filter(target == "yes") %>%
summarise(targetRichness = sum(n, na.rm = TRUE)) %>%
ungroup()
### * seeded species (species richness) ####
speciesRichness_seeded <- species %>%
select(-starts_with("C"), -contains("x0809")) %>%
# Make two columns out of column id:
pivot_longer(-name, names_to = "id", values_to = "value",
values_drop_na = TRUE) %>%
separate(id, c("plot", "surveyYear"), sep = "_(?!.*_)",
remove = FALSE, extra = "merge", fill = "warn", convert = FALSE) %>%
# Summarise for plot:
pivot_wider(names_from = "surveyYear", values_from = "value") %>%
group_by(plot, name) %>%
summarise(across(where(is.double), ~sum(.x, na.rm = TRUE)),
.groups = "keep") %>%
ungroup() %>%
# Combine with seedmixes:
pivot_longer(starts_with("20"), names_to = "surveyYear", values_to = "value",
names_transform = list(surveyYear = as.factor)) %>%
unite(id_seeded, name, plot, sep = "", remove = FALSE) %>%
left_join(seedmixes %>%
unite(id_seeded, name, plot, sep = "", remove = TRUE),
by = "id_seeded") %>%
select(-id_seeded) %>%
mutate(successCov = if_else(seeded > 0 & value > 0, 1, 0)) %>%
group_by(plot, surveyYear) %>%
summarise(seededRichness = sum(successCov, na.rm = TRUE),
.groups = "keep") %>%
ungroup() %>%
unite(id, plot, surveyYear, sep = "_")
### * ffh6510 species (species richness) ####
speciesRichness_ffh6510 <- speciesRichness %>%
filter(ffh6510 == "yes") %>%
summarise(ffh6510Richness = sum(n, na.rm = TRUE)) %>%
ungroup()
### * ffh6210 species (species richness) ####
speciesRichness_ffh6210 <- speciesRichness %>%
filter(ffh6210 == "yes") %>%
summarise(ffh6210Richness = sum(n, na.rm = TRUE)) %>%
ungroup()
### * implement in sites data set ####
sites <- sites %>%
left_join(speciesRichness_all, by = "id") %>%
left_join(speciesRichness_rlg, by = "id") %>%
left_join(speciesRichness_rlb, by = "id") %>%
left_join(speciesRichness_target, by = "id") %>%
left_join(speciesRichness_seeded, by = "id") %>%
left_join(speciesRichness_ffh6510, by = "id") %>%
left_join(speciesRichness_ffh6210, by = "id") %>%
### Create targetRichratio ###
mutate(targetRichratio = targetRichness / speciesRichness,
seededRichratio = seededRichness / speciesRichness,
targetRichratio = round(targetRichratio, 3),
seededRichratio = round(seededRichratio, 3))
### b Species eveness and shannon ----------------------------------------------
data <- species  %>%
mutate(across(where(is.numeric), ~replace(., is.na(.), 0))) %>%
pivot_longer(-name, names_to = "id", values_to = "value") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
column_to_rownames("id") %>%
diversity(index = "shannon") %>%
as_tibble(rownames = NA) %>%
rownames_to_column(var = "id") %>%
mutate(id = factor(id)) %>%
rename(shannon = value)
sites <- sites %>%
left_join(data, by = "id") %>%
mutate(eveness = shannon / log(speciesRichness))
rm(list = ls(pattern = "[^species|traits|sites|seedmixes]"))
rm(list = setdiff(ls(), c("sites", "species", "traits", "seedmixes")))
### * Prepare data ####
data_sites <- sites %>%
# Choose only plots which were surveyed in each year:
filter(accumulatedCov > 0) %>%
add_count(plot) %>%
filter(n == max(n)) %>%
select(id, plot)
data_species <- species %>%
select(where(~ !all(is.na(.x)))) %>%
mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>%
pivot_longer(-name, names_to = "id", values_to = "value") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
separate(id, c("plot", "year"), sep = "_(?!.*_)",
remove = FALSE, extra = "merge", fill = "warn", convert = FALSE) %>%
arrange(id) %>%
semi_join(data_sites, by = "id") %>%
select(plot, year, tidyselect::peek_vars(), -id)
species_seeded <- seedmixes %>%
pivot_wider(names_from = "name", values_from = "seeded") %>%
arrange(plot) %>%
column_to_rownames("plot") %>%
mutate(across(where(is.numeric), ~replace(., is.na(.), 0)))
for (i in unique(data_species$year)) {
nam <- paste("species", i, sep = "")
assign(nam, data_species %>%
filter(year == i) %>%
select(-year) %>%
column_to_rownames(var = "plot"))
}
#### * seedmixes vs. 2018 ####
res18 <- TBI(species_seeded, species2018,
method = "sorensen",
nperm = 9999, test.t.perm = TRUE, clock = TRUE)
### Packages ###
library(here)
library(tidyverse)
library(naniar) #are_na
library(vegan)
library(adespatial)
library(FD) #dbFD
#remotes::install_github(file.path("inbo", "checklist"))
### * Prepare data ####
data_sites <- sites %>%
# Choose only plots which were surveyed in each year:
filter(accumulatedCov > 0) %>%
add_count(plot) %>%
filter(n == max(n)) %>%
select(id, plot)
data_species <- species %>%
select(where(~ !all(is.na(.x)))) %>%
mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>%
pivot_longer(-name, names_to = "id", values_to = "value") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
separate(id, c("plot", "year"), sep = "_(?!.*_)",
remove = FALSE, extra = "merge", fill = "warn", convert = FALSE) %>%
arrange(id) %>%
semi_join(data_sites, by = "id") %>%
select(plot, year, tidyselect::peek_vars(), -id)
species_seeded <- seedmixes %>%
pivot_wider(names_from = "name", values_from = "seeded") %>%
arrange(plot) %>%
column_to_rownames("plot") %>%
mutate(across(where(is.numeric), ~replace(., is.na(.), 0)))
for (i in unique(data_species$year)) {
nam <- paste("species", i, sep = "")
assign(nam, data_species %>%
filter(year == i) %>%
select(-year) %>%
column_to_rownames(var = "plot"))
}
#### * seedmixes vs. 2018 ####
res18 <- TBI(species_seeded, species2018,
method = "sorensen",
nperm = 9999, test.t.perm = TRUE, clock = TRUE)
res18$BCD.summary # B = 0.223, C = 0.155, D = 0.378 (58.9% vs. 41.0%)
#### * seedmixes vs. 2019 ####
res19 <- TBI(species_seeded, species2019,
method = "sorensen",
nperm = 9999, test.t.perm = TRUE, clock = TRUE)
res19$BCD.summary # B = 0., C = 0., D = 0. (% vs. %)
res19$t.test_B.C # p.perm = 0.
tbi19 <- res19$BCD.mat %>%
as_tibble() %>%
mutate(comparison = "19")
#### Test plot
plot(res19, type = "BC")
#### * seedmixes vs. 2020 ####
res20 <- TBI(species_seeded, species2020,
method = "sorensen",
nperm = 9999, test.t.perm = TRUE, clock = TRUE)
res20$BCD.summary # B = 0., C = 0., D = 0. (% vs. %)
res20$t.test_B.C # p.perm = 0.
tbi20 <- res20$BCD.mat %>%
as_tibble() %>%
mutate(comparison = "20")
#### Test plot
plot(res20, type = "BC")
#### * seedmixes vs. 2021 ####
res21 <- TBI(species_seeded, species2021,
method = "sorensen",
nperm = 9999, test.t.perm = TRUE, clock = TRUE)
res21$BCD.summary # B = 0., C = 0., D = 0. (% vs. %)
res21$t.test_B.C # p.perm = 0.
tbi21 <- res21$BCD.mat %>%
as_tibble() %>%
mutate(comparison = "21")
#### Test plot
plot(res21, type = "BC")
#### * Combine datasets ####
data_presence <- bind_rows(tbi18, tbi19, tbi20, tbi21) %>%
mutate(presabu = "abundance")
plot <- data_sites %>%
filter(str_detect(id, "2018")) %>%
pull(plot)
res19$t.test_B.C # p.perm = 0.
tbi19 <- res19$BCD.mat %>%
as_tibble() %>%
mutate(comparison = "19")
#### Test plot
plot(res19, type = "BC")
res18$BCD.summary # B = .566, C = .308, D = .874 (.647 vs. .352)
res18$t.test_B.C # p.perm = .
tbi18 <- res18$BCD.mat %>%
as_tibble() %>%
mutate(comparison = "18")
#### Test plot
plot(res18, type = "BC")
res21$BCD.summary # B = 0., C = 0., D = 0. (% vs. %)
res21$t.test_B.C # p.perm = 0.
tbi21 <- res21$BCD.mat %>%
as_tibble() %>%
mutate(comparison = "21")
#### Test plot
plot(res21, type = "BC")
#### * Combine datasets ####
data_presence <- bind_rows(tbi18, tbi19, tbi20, tbi21) %>%
mutate(presabu = "presence")
rm(list = setdiff(ls(), c(
"sites", "species", "traits", "seedmixes", "species_seeded",
"species2018", "species2019", "species2020", "species2021"
)))
#### * seedmixes vs. 2018 ####
res18 <- TBI(species_seeded, species2018,
method = "%difference",
nperm = 9999, test.t.perm = TRUE, clock = TRUE)
res18$BCD.summary # B = .566, C = .308, D = .874 (.647 vs. .352)
res18$t.test_B.C # p.perm = .
tbi18 <- res18$BCD.mat %>%
as_tibble() %>%
mutate(comparison = "18")
#### Test plot
plot(res18, type = "BC")
#### * seedmixes vs. 2019 ####
res19 <- TBI(species_seeded, species2019,
method = "%difference",
nperm = 9999, test.t.perm = TRUE, clock = TRUE)
res19$BCD.summary # B = ., C = ., D = . (. vs. .)
res19$t.test_B.C # p.perm = .422
tbi19 <- res19$BCD.mat %>%
as_tibble() %>%
mutate(comparison = "19")
#### Test plot
plot(res19, type = "BC")
#### * seedmixes vs. 2020 ####
res20 <- TBI(species_seeded, species2020,
method = "%difference",
nperm = 9999, test.t.perm = TRUE, clock = TRUE)
res20$BCD.summary # B = ., C = ., D = . (. vs. .)
res20$t.test_B.C # p.perm =
tbi20 <- res20$BCD.mat %>%
as_tibble() %>%
mutate(comparison = "20")
#### Test plot
plot(res20, type = "BC")
#### * seedmixes vs. 2021 ####
res21 <- TBI(species_seeded, species2021,
method = "%difference",
nperm = 9999, test.t.perm = TRUE, clock = TRUE)
res21$BCD.summary # B = ., C = ., D = . ( vs. )
res21$t.test_B.C # p.perm = .
tbi21 <- res21$BCD.mat %>%
as_tibble() %>%
mutate(comparison = "21")
#### Test plot
plot(res21, type = "BC")
#### * Combine datasets ####
data_presence <- bind_rows(tbi18, tbi19, tbi20, tbi21) %>%
mutate(presabu = "abundance")
plot <- data_sites %>%
filter(str_detect(id, "2018")) %>%
pull(plot)
### * Prepare data ####
data_sites <- sites %>%
# Choose only plots which were surveyed in each year:
filter(accumulatedCov > 0) %>%
add_count(plot) %>%
filter(n == max(n)) %>%
select(id, plot)
data_species <- species %>%
select(where(~ !all(is.na(.x)))) %>%
mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>%
pivot_longer(-name, names_to = "id", values_to = "value") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
separate(id, c("plot", "year"), sep = "_(?!.*_)",
remove = FALSE, extra = "merge", fill = "warn", convert = FALSE) %>%
arrange(id) %>%
semi_join(data_sites, by = "id") %>%
select(plot, year, tidyselect::peek_vars(), -id)
species_seeded <- seedmixes %>%
pivot_wider(names_from = "name", values_from = "seeded") %>%
arrange(plot) %>%
column_to_rownames("plot") %>%
mutate(across(where(is.numeric), ~replace(., is.na(.), 0)))
for (i in unique(data_species$year)) {
nam <- paste("species", i, sep = "")
assign(nam, data_species %>%
filter(year == i) %>%
select(-year) %>%
column_to_rownames(var = "plot"))
}
plot <- data_sites %>%
filter(str_detect(id, "2018")) %>%
pull(plot)
View(data_sites)
plot <- data_sites %>%
mutate(plot = factor(plot)) %>%
filter(str_detect(id, "2018")) %>%
pull(plot)
### combine abundance and presence data ###
data <- add_row(data_presence, data_abundance) #%>%
#### * Combine datasets ####
data_abundance <- bind_rows(tbi18, tbi19, tbi20, tbi21) %>%
mutate(presabu = "abundance")
plot <- data_sites %>%
mutate(plot = factor(plot)) %>%
filter(str_detect(id, "2018")) %>%
pull(plot)
### combine abundance and presence data ###
data <- add_row(data_presence, data_abundance) #%>%
View(data)
View(data_abundance)
### combine abundance and presence data ###
data <- add_row(data_presence, data_abundance) %>%
mutate(plot = rep(plot, length(data_abundance$comparison) * 2 / 288))
View(data)
View(sites)
sites_temporal <- sites %>%
filter(factor(surveyYear) == "2018") %>%
left_join(data, by = "plot") %>%
rename(
B = "B/(2A+B+C)", C = "C/(2A+B+C)", D = "D=(B+C)/(2A+B+C)",
change = Change
) %>%
mutate(
change = C - B,
plot = as_factor(plot)
) %>%
select(
plot, block,
exposition, seedDensity, targetType, substrateDepth, sandRatio,
B, C, D, comparison, presabu
) %>%
mutate(across(c(B, C, D), ~ round(.x, digits = 4)))
View(sites_temporal)
### combine abundance and presence data:
data <- add_row(data_presence, data_abundance) %>%
mutate(plot = rep(plot, length(data_abundance$comparison) * 2 / 288),
id = str_c(plot, comparison, sep = "_")) %>%
rename(
B = "B/(2A+B+C)", C = "C/(2A+B+C)", D = "D=(B+C)/(2A+B+C)",
change = Change
) %>%
mutate(
change = C - B,
plot = as_factor(plot)
)
View(data)
View(sites)
### combine abundance and presence data:
data <- add_row(data_presence, data_abundance) %>%
mutate(plot = rep(plot, length(data_abundance$comparison) * 2 / 288),
id = str_c(plot, comparison, sep = "_")) %>%
rename(
B = "B/(2A+B+C)", C = "C/(2A+B+C)", D = "D=(B+C)/(2A+B+C)",
change = Change
) %>%
mutate(change = C - B,
across(c(B, C, D, change), ~ round(.x, digits = 4))) %>%
select(id, B, C, D)
